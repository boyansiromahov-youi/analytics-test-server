<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href='youi.png'>
    <title>Youi Analytics Testing Tool</title>

    <!-- Bootstrap Core CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- MetisMenu CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/metisMenu/3.0.4/metisMenu.min.css" rel="stylesheet">
    <!-- Social Buttons CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-social/5.1.1/bootstrap-social.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/startbootstrap-sb-admin-2/3.3.7+1/css/sb-admin-2.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
</head>
<body>
    <div id="wrapper" style="margin: 0px 30px">
            <div class="row">
                <div class="col-lg-12">
                    <h1>
                        <img src='youi.png' alt="youi" width='70' height='70' alt="You i"/>
                        Analytics Testing Tool 
                    </h1>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Adobe Analytics
                        </div>
                        <select id="selector" style="margin: 5px 0px;" onchange="anaSelected()" disabled>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-lg-12">
                <textarea id="Analytics" rows="4" cols="50" style="margin: 0px -15px; width: 705px; height: 450px; resize: none" disabled=true>
                </textarea>
            </div>
            <label class="switch">
                Live Feed OFF
                <input type="checkbox" onclick="pause()" id="pause">
                <span class="slider round"></span>
            </label>
            <button type="button" style="margin: 0px 5px" onclick="exportCur()">Export</button>
            <button type="button" style="margin: 0px 5px" onclick="exportAll()">Export All</button>
    </div>  
</body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script>
    $.ajax;
    var isLastIndex = true;
    function refresh(){
        window.location.reload(true);  
    }
    var paused = false;
    //User has selected a analytic call from the drop down.
    function anaSelected(){
        isLastIndex = false;
        var index = document.getElementById("selector").selectedIndex;
        var opt = document.getElementById("selector").options[index];
        ws.send('command/select/' + opt.text);
    }
    function pause(){
        isLastIndex = true;
        paused = !paused;
        ws.send('command/radio')
        if (paused){
            document.getElementById("selector").disabled=false
        }else
        {
            document.getElementById("selector").disabled=true
        }       
    }
    var ws = new WebSocket('ws://localhost:40510');
    // event emmited when connected
    ws.onopen = function () {
        console.log('websocket is connected')
        // sending a send event to websocket server
        ws.send('connected')
    }
    // event emmited when receiving message 
    ws.onmessage = function (ev) {
        console.log(ev);
        //server lets us know that new data came in and we need to refresh the page
        if(ev.data == "Data"){
            window.location.reload(true);
            console.log("New Data recieved");
        }
        //sever lets us know that text field needs to be updated
        else if(ev.data.includes("txt/")){
            var str = ev.data.replace("txt/" , '');
            document.getElementById("Analytics").textContent = str;
        }
        else if(ev.data.includes("select/")){
            var select = document.getElementById("selector");
            console.log(ev.data);
            var keys = ev.data.replace("select/" , '').split('/');
            console.log(keys);
            var first = select.firstElementChild;     
            while (first != null)
            {
                select.removeChild(first);
                first = select.firstElementChild;
            }

            for (var i = 0; i<keys.length; i++){      
                option = document.createElement("option");
                option.text = keys[i];
                select.appendChild(option);
            }
        }
        else{
            console.log('Unkown command: ' + ev.data);
        }
    }

    function exportCur(){
        console.log(isLastIndex);
        if(isLastIndex){
            var theSelect = document.getElementById("selector");
            console.log(theSelect);
            var lastValue = theSelect.options[theSelect.options.length - 1];
            console.log(lastValue);
            ws.send('command/exportCur/' + lastValue.text);
        }else if (paused){
            var index = document.getElementById("selector").selectedIndex;
            var opt = document.getElementById("selector").options[index];
            ws.send('command/exportCur/' + opt.text);
        }else{
            ws.send('command/exportCur/');
        }
    }
    function exportAll(){
         ws.send('command/exportAll');
    }
</script>
</html>
